pipeline {
  agent {
    kubernetes {
      yamlFile 'jenkins/pod_template/locust.yaml'
    }
  }

  options {
    timeout(time: 5, unit: 'MINUTES')
  }

  parameters {
    string(name: 'SERVICE', defaultValue: '', description: 'Service to check (ex. sample.default.svc.cluster.local)')
    string(name: 'EXTERNAL_URL', defaultValue: 'google.com', description: 'External URL to check (ex. google.com)')
  }

  stages {
    stage('Setup') {
      steps {
        script {
          container('master') {
            sh 'locust -V'
            sh 'cat script/locust.py'
          }
        }
      }
    }
    stage('Load Test') {
      parallel {
        stage('worker01') {
          steps {
            container("${STAGE_NAME}") {
              sh 'cat script/locust.py'
            }
          }
        }
        stage('worker02') {
          steps {
            container("${STAGE_NAME}") {
              sh 'cat script/locust.py'
            }
          }
        }
      }
    }
  }
  post{
    always {
      slackSend(color: "${currentBuild.currentResult  == 'SUCCESS' ? 'good' : 'danger'}", message: """
Job    : ${env.JOB_NAME} #${env.BUILD_NUMBER}
Status : ${currentBuild.currentResult}
URL    : ${env.BUILD_URL}
Params : ${params} 
      """)
    }
  }
}