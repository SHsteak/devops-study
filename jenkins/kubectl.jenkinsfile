pipeline {
  agent {
    kubernetes {
      yamlFile 'jenkins/pod_template/kubectl.yaml'
    }
  }

  options {
    timeout(time: 10, unit: 'MINUTES')
  }

  parameters {
    string(name: 'FUNC', defaultValue: '', description: 'Bash script function name')
    string(name: 'NAMESPACE', defaultValue: '', description: 'Namespace')
    string(name: 'RESOURCE', defaultValue: '', description: 'Resource Name (ex. deployment, svc)')
    string(name: 'NAME', defaultValue: '', description: 'Name')
    string(name: 'REPLICAS', defaultValue: '', description: 'Number to scale deployment')
  }
  
  environment {
    FUNC = "${params.FUNC}"
    NAMESPACE = "${params.NAMESPACE}"
    RESOURCE = "${params.RESOURCE}"
    NAME = "${params.NAME}"
    REPLICAS = "${params.REPLICAS}"
  }

  stages {
    stage('Test') {
      steps {
        script {
          container('kubectl') {
            stage("Validate Parameter") {
              if( !params.FUNC || !params.NAMESPACE ){
                echo 'Parameter is invalid'
                return
              }else{
                echo 'Parameter is valid'
              }
            }
            stage("Exec kubectl") {
              dir('script') {
                sh '''
                  kubectl get po
                  echo $NAMESPACE
                  chmod +x kubectl_func.sh
                  
                  ./kubectl_func.sh $FUNC
                '''
              }
            }
          }
        }
      }
    }
  }
}